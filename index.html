<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Отчет по работе групп</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Основные стили */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fff;
        }

        /* Стили для фильтров */
        .filters-container {
            padding: 15px 0;
            margin-bottom: 20px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 14px;
            white-space: nowrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 14px;
            background-color: #fff;
            transition: border-color 0.15s ease-in-out;
        }

        .date-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        .warning-icon {
            color: #e67e22;
            background-color: #fef9e7;
            padding: 3px 8px;
            border-radius: 50%;
            font-size: 1.2em;
            margin-left: 8px;
            font-weight: bold;
            cursor: help;
            position: relative;
            display: inline-block;
        }

        .warning-icon:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #fff;
            color: #333;
            text-align: left;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1000;
            top: 100%;
            left: -120px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border: 1px solid #e0e0e0;
            font-size: 0.9em;
            font-weight: normal;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 130px;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent #fff transparent;
        }

        /* Стили для кнопок */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .btn-secondary {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        /* Стили для селектов */
        select {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background-color: #fff;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            cursor: pointer;
            min-width: 120px;
        }

        select:hover {
            border-color: #adb5bd;
        }

        select:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* Стили для вкладок */
        .tabs {
            display: flex;
            border-bottom: 1px solid #dee2e6;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-button {
            padding: 12px 16px;
            background-color: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            color: #007bff;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Стили для таблиц */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }

        .main-table {
            font-size: 1.1rem;
        }

        .main-table th {
            font-size: 1rem;
            padding: 16px 20px;
        }

        .main-table td {
            padding: 16px 20px;
            font-size: 1.1rem;
        }

        .main-table .expandable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .main-table .expandable-row:hover {
            background-color: #f8f9fa;
        }

        .main-table .detail-row {
            background-color: #e9ecef;
            font-size: 1rem;
        }

        .expand-icon {
            font-size: 0.8rem;
            margin-left: 8px;
            color: #6c757d;
            transition: transform 0.2s ease;
        }

        h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #495057;
        }

        th,
        td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            font-size: 0.85em;
            text-transform: uppercase;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .text-right {
            text-align: right;
        }

        .text-center {
            text-align: center;
        }

        /* Стили для бейджей */
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.75em;
            margin-left: 6px;
        }

        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        .badge-neutral {
            background-color: #e9ecef;
            color: #6c757d;
        }

        /* Стили для процентов */
        .percentage-high {
            color: #dc3545;
            font-weight: 600;
        }

        .percentage-medium {
            color: #fd7e14;
            font-weight: 600;
        }

        .percentage-low {
            color: #28a745;
            font-weight: 600;
        }

        /* Утилиты */
        .mt-4 {
            margin-top: 1rem;
        }

        .mb-4 {
            margin-bottom: 1rem;
        }

        /* Стили для загрузки */
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Вкладки -->
        <div class="tabs">
            <button class="tab-button active" data-tab="company">Компания</button>
            <button class="tab-button" data-tab="departments">Подразделения</button>
            <button class="tab-button" data-tab="employees">Команда</button>
        </div>

        <!-- Company Tab Content -->
        <div id="companyTab" class="tab-content active">
            <!-- Фильтры -->
            <div class="filters-container">
                <div class="filter-group">
                    <div class="filter-item">
                        <span class="filter-label">Период с:</span>
                        <input type="date" id="startDate" value="2025-07-01" class="date-input">
                    </div>
                    <div class="filter-item">
                        <span class="filter-label">по:</span>
                        <input type="date" id="endDate" value="2025-07-31" class="date-input">
                        <span class="warning-icon">!
                            <span class="tooltip-text">Ограничения периода выборки:<br>
                                • Месяц - максимум 31 день<br>
                                • Неделя - максимум 7 дней<br>
                                • День - максимум 1 день
                            </span>
                        </span>
                    </div>
                </div>

                <div class="filter-group">
                    <div class="filter-item">
                        <span class="filter-label">Режим отображения:</span>
                        <select id="timeGranularity">
                            <option value="День">День</option>
                            <option value="Неделя">Неделя</option>
                            <option value="Месяц" selected>Месяц</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <select id="callCenter">
                            <option value="Все КЦ">Все КЦ</option>
                            <option value="КЦ 1">КЦ 1</option>
                            <option value="КЦ 2">КЦ 2</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <span class="filter-label">Дашборд:</span>
                        <select id="dashboard">
                            <option value="Автооценка" selected>Автооценка</option>
                            <option value="Автооценка УАВ/ПреХард">Автооценка УАВ/ПреХард</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <button id="updateButton" class="btn btn-primary">Обновить</button>
                    </div>
                </div>
            </div>

            <!-- Информационное примечание -->
            <div class="warning-icon" style="margin-bottom: 15px; display: inline-block;">
                <span
                    style="background-color: #e3f2fd; color: #1976d2; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: normal;">
                    ℹ️ Изменения показаны относительно предыдущего периода
                    <span id="periodInfo">(01.06.2025 - 30.06.2025)</span>
                </span>
            </div>

            <!-- Таблица с данными сводной информации -->
            <div id="companySummaryTable" class="mt-4">
                <div class="loading">Загрузка данных...</div>
                <div id="debugInfo"
                    style="margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 4px; font-family: monospace; font-size: 12px;">
                </div>
            </div>
        </div>

        <!-- Departments Tab Content -->
        <div id="departmentsTab" class="tab-content">
            <!-- Информационное примечание -->
            <div class="warning-icon" style="margin-bottom: 15px; display: inline-block;">
                <span
                    style="background-color: #e3f2fd; color: #1976d2; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: normal;">
                    ℹ️ Изменения показаны относительно предыдущего периода
                    <span id="departmentsPeriodInfo">(01.06.2025 - 30.06.2025)</span>
                </span>
            </div>
            <div id="departmentsTable" class="mt-4">
                <div class="loading">Загрузка данных...</div>
            </div>
        </div>

        <!-- Employees Tab Content -->
        <div id="employeesTab" class="tab-content">
            <!-- Информационное примечание -->
            <div class="warning-icon" style="margin-bottom: 15px; display: inline-block;">
                <span
                    style="background-color: #e3f2fd; color: #1976d2; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: normal;">
                    ℹ️ Изменения показаны относительно предыдущего периода
                    <span id="employeesPeriodInfo">(01.06.2025 - 30.06.2025)</span>
                </span>
            </div>
            <div id="employeesTable" class="mt-4">
                <div class="loading">Загрузка данных...</div>
            </div>
        </div>
    </div>

    <!-- Подключение JavaScript файлов -->
    <script src="js/data/real-data-processor.js"></script>

    <script>
        // Отладка загрузки
        console.log('=== ОТЛАДКА ЗАГРУЗКИ ===');
        console.log('Скрипт загружен');

        function updateDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            if (debugDiv) {
                debugDiv.innerHTML += message + '<br>';
            }
        }

        // Проверяем доступность функций
        setTimeout(() => {
            console.log('Проверяем функции через 1 секунду...');
            updateDebugInfo('Проверяем функции...');

            const functions = {
                'loadOperatorData': typeof loadOperatorData,
                'getCompanyData': typeof getCompanyData,
                'getDepartmentsData': typeof getDepartmentsData,
                'getEmployeesData': typeof getEmployeesData
            };

            for (const [name, type] of Object.entries(functions)) {
                console.log(`${name}:`, type);
                updateDebugInfo(`${name}: ${type}`);
            }

            // Если функции доступны, пробуем загрузить данные
            if (typeof loadOperatorData === 'function') {
                updateDebugInfo('Пробуем загрузить данные...');

                // Сначала проверим, можем ли мы вообще делать fetch запросы
                fetch('callcenter_operator_data.json')
                    .then(response => {
                        updateDebugInfo(`Fetch ответ: ${response.status} ${response.statusText}`);
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.text();
                    })
                    .then(text => {
                        updateDebugInfo(`Получен текст длиной: ${text.length} символов`);
                        try {
                            const data = JSON.parse(text);
                            updateDebugInfo(`JSON распарсен: ${Object.keys(data).length} операторов`);

                            // Теперь пробуем через нашу функцию
                            return loadOperatorData();
                        } catch (parseError) {
                            updateDebugInfo(`Ошибка парсинга JSON: ${parseError.message}`);
                            throw parseError;
                        }
                    })
                    .then(data => {
                        if (data) {
                            updateDebugInfo(`✅ Данные успешно загружены через loadOperatorData: ${Object.keys(data).length} операторов`);

                            // Пробуем получить данные компании
                            return getCompanyData('2025-07-01', '2025-07-31', 'Месяц', 'Все КЦ');
                        } else {
                            updateDebugInfo('❌ loadOperatorData вернула null');
                        }
                    })
                    .then(companyData => {
                        if (companyData) {
                            updateDebugInfo(`✅ Данные компании получены: ${companyData.current.total.calls} звонков`);
                        } else {
                            updateDebugInfo('❌ Данные компании не получены');
                        }
                    })
                    .catch(error => {
                        updateDebugInfo(`❌ Ошибка: ${error.message}`);
                        console.error('Детальная ошибка:', error);

                        // Дополнительная информация об ошибке
                        if (error.message.includes('CORS')) {
                            updateDebugInfo('💡 Возможно, нужно запустить локальный сервер');
                        }
                        if (error.message.includes('file://')) {
                            updateDebugInfo('💡 Попробуйте открыть через HTTP сервер, а не file://');
                        }
                    });
            } else {
                updateDebugInfo('❌ Функция loadOperatorData не найдена!');
            }
        }, 1000);
    </script>

    <script>
        // Глобальные переменные
        let currentTab = 'company';

        // Функция для валидации диапазона дат
        function validateDateRange(startDate, endDate, granularity) {
            if (!startDate || !endDate) {
                alert('Пожалуйста, выберите начальную и конечную даты');
                return false;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let maxDays;
            let errorMessage;

            switch (granularity) {
                case 'День':
                    maxDays = 1;
                    errorMessage = 'При выборе режима "День" можно выбрать максимум 1 день';
                    break;
                case 'Неделя':
                    maxDays = 7;
                    errorMessage = 'При выборе режима "Неделя" можно выбрать максимум 7 дней';
                    break;
                case 'Месяц':
                    maxDays = 31;
                    errorMessage = 'При выборе режима "Месяц" можно выбрать максимум 31 день';
                    break;
                default:
                    return true;
            }

            if (diffDays > maxDays) {
                alert(errorMessage);
                return false;
            }

            return true;
        }

        // Функция для расчета процентного изменения
        function calculateChange(current, previous) {
            if (!previous || previous === 0) {
                return current > 0 ? 100 : 0;
            }

            const change = ((current - previous) / previous) * 100;
            return Math.round(change * 10) / 10;
        }

        // Функция для создания бейджа с изменением
        function createChangeBadge(current, previous) {
            const change = calculateChange(current, previous);
            const sign = change > 0 ? '+' : '';
            const cssClass = change > 0 ? 'badge-success' : (change < 0 ? 'badge-danger' : 'badge-neutral');

            return `<span class="badge ${cssClass}">${sign}${change}%</span>`;
        }

        // Функция для получения CSS класса процента
        function getPercentageClass(percentage) {
            if (percentage >= 10) {
                return 'percentage-high';
            } else if (percentage >= 5) {
                return 'percentage-medium';
            } else {
                return 'percentage-low';
            }
        }

        // Функция для обновления информации о периоде
        function updatePeriodInfo(granularity, elementId) {
            const periodInfoElement = document.getElementById(elementId);
            if (!periodInfoElement) return;

            // Получаем выбранные даты
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                periodInfoElement.textContent = '(предыдущий период)';
                return;
            }

            // Используем функцию getPreviousPeriod из real-data-processor.js
            const previousPeriod = getPreviousPeriod(startDate, endDate, granularity);

            let previousPeriodText = '';

            switch (granularity) {
                case 'День':
                    const prevDate = new Date(previousPeriod.startDate);
                    previousPeriodText = `(${prevDate.toLocaleDateString('ru-RU')})`;
                    break;
                case 'Неделя':
                    const prevStartWeek = new Date(previousPeriod.startDate);
                    const prevEndWeek = new Date(previousPeriod.endDate);
                    previousPeriodText = `(${prevStartWeek.toLocaleDateString('ru-RU')} - ${prevEndWeek.toLocaleDateString('ru-RU')})`;
                    break;
                case 'Месяц':
                    const prevStartMonth = new Date(previousPeriod.startDate);
                    const prevEndMonth = new Date(previousPeriod.endDate);
                    previousPeriodText = `(${prevStartMonth.toLocaleDateString('ru-RU')} - ${prevEndMonth.toLocaleDateString('ru-RU')})`;
                    break;
                default:
                    previousPeriodText = '(предыдущий период)';
            }

            periodInfoElement.textContent = previousPeriodText;
        }

        // Функция для отображения ошибки
        function showError(containerId, message) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `<div class="error">Ошибка: ${message}</div>`;
            }
        }

        // Функция для отображения загрузки
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = '<div class="loading">Загрузка данных...</div>';
            }
        }

        // Функция для раскрытия/скрытия деталей
        function toggleExpansion(rowId) {
            const detailRows = document.querySelectorAll(`[id^="${rowId}"]`);
            const icon = document.getElementById(rowId.replace('-row', '-icon'));

            let isExpanded = false;
            detailRows.forEach(row => {
                if (row.style.display === 'none' || row.style.display === '') {
                    row.style.display = 'table-row';
                    isExpanded = true;
                } else {
                    row.style.display = 'none';
                }
            });

            // Обновляем иконку
            if (icon) {
                icon.textContent = isExpanded ? '▲' : '▼';
            }
        }

        // Функция для обновления данных компании
        async function updateCompanyData() {
            console.log('=== updateCompanyData вызвана ===');

            const granularity = document.getElementById('timeGranularity').value;
            const callCenter = document.getElementById('callCenter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            console.log('Параметры:', { granularity, callCenter, startDate, endDate });

            showLoading('companySummaryTable');
            updatePeriodInfo(granularity, 'periodInfo');

            try {
                console.log('Вызываем getCompanyData...');
                const companyData = await getCompanyData(startDate, endDate, granularity, callCenter);
                console.log('Получены данные компании:', companyData);

                if (!companyData) {
                    console.error('companyData is null');
                    showError('companySummaryTable', 'Не удалось загрузить данные компании');
                    return;
                }

                console.log('Вызываем renderCompanyTable...');
                renderCompanyTable(companyData, callCenter);
                console.log('renderCompanyTable завершена');
            } catch (error) {
                console.error('Ошибка при обновлении данных компании:', error);
                showError('companySummaryTable', error.message);
            }
        }

        // Функция для отрисовки таблицы компании
        function renderCompanyTable(companyData, selectedCallCenter) {
            const tableContainer = document.getElementById('companySummaryTable');
            if (!tableContainer) return;

            let tableHTML = '';

            // Если выбраны все КЦ, показываем разбивку по КЦ
            if (selectedCallCenter === 'Все КЦ') {
                const currentData = companyData.current;
                const previousData = companyData.previous;

                const totalData = currentData.total;
                const kc1Data = currentData.kc1;
                const kc2Data = currentData.kc2;
                const rpcTotalData = currentData.rpc.total;
                const nonRpcTotalData = currentData.nonRpc.total;
                const rpcKc1Data = currentData.rpc.kc1;
                const nonRpcKc1Data = currentData.nonRpc.kc1;
                const rpcKc2Data = currentData.rpc.kc2;
                const nonRpcKc2Data = currentData.nonRpc.kc2;

                // Данные предыдущего периода
                const prevTotalData = previousData.total;
                const prevKc1Data = previousData.kc1;
                const prevKc2Data = previousData.kc2;
                const prevRpcTotalData = previousData.rpc.total;
                const prevNonRpcTotalData = previousData.nonRpc.total;
                const prevRpcKc1Data = previousData.rpc.kc1;
                const prevNonRpcKc1Data = previousData.nonRpc.kc1;
                const prevRpcKc2Data = previousData.rpc.kc2;
                const prevNonRpcKc2Data = previousData.nonRpc.kc2;

                tableHTML = `
                    <table class="main-table">
                        <thead>
                            <tr>
                                <th>КОЛЛ-ЦЕНТР</th>
                                <th class="text-right">ВСЕГО ЗВОНКОВ</th>
                                <th class="text-right">ОТКЛОНЕНИЯ</th>
                                <th class="text-right">% ОТКЛОНЕНИЙ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="expandable-row" onclick="toggleExpansion('total-row')">
                                <td><strong>Всего</strong> <span class="expand-icon" id="total-icon">▼</span></td>
                                <td class="text-right"><strong>${totalData.calls.toLocaleString()}</strong> ${createChangeBadge(totalData.calls, prevTotalData.calls)}</td>
                                <td class="text-right"><strong>${totalData.deviations.toLocaleString()}</strong> ${createChangeBadge(totalData.deviations, prevTotalData.deviations)}</td>
                                <td class="text-right"><strong><span class="${getPercentageClass(totalData.percentage)}">${totalData.percentage}%</span></strong> ${createChangeBadge(totalData.percentage, prevTotalData.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="total-row" style="display: none;">
                                <td style="padding-left: 30px;">RPC</td>
                                <td class="text-right">${rpcTotalData.calls.toLocaleString()} ${createChangeBadge(rpcTotalData.calls, prevRpcTotalData.calls)}</td>
                                <td class="text-right">${rpcTotalData.deviations.toLocaleString()} ${createChangeBadge(rpcTotalData.deviations, prevRpcTotalData.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(rpcTotalData.percentage)}">${rpcTotalData.percentage}%</span> ${createChangeBadge(rpcTotalData.percentage, prevRpcTotalData.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="total-row-2" style="display: none;">
                                <td style="padding-left: 30px;">Не RPC</td>
                                <td class="text-right">${nonRpcTotalData.calls.toLocaleString()} ${createChangeBadge(nonRpcTotalData.calls, prevNonRpcTotalData.calls)}</td>
                                <td class="text-right">${nonRpcTotalData.deviations.toLocaleString()} ${createChangeBadge(nonRpcTotalData.deviations, prevNonRpcTotalData.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(nonRpcTotalData.percentage)}">${nonRpcTotalData.percentage}%</span> ${createChangeBadge(nonRpcTotalData.percentage, prevNonRpcTotalData.percentage)}</td>
                            </tr>
                            <tr class="expandable-row" onclick="toggleExpansion('kc1-row')">
                                <td>КЦ 1 <span class="expand-icon" id="kc1-icon">▼</span></td>
                                <td class="text-right">${kc1Data.calls.toLocaleString()} ${createChangeBadge(kc1Data.calls, prevKc1Data.calls)}</td>
                                <td class="text-right">${kc1Data.deviations.toLocaleString()} ${createChangeBadge(kc1Data.deviations, prevKc1Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(kc1Data.percentage)}">${kc1Data.percentage}%</span> ${createChangeBadge(kc1Data.percentage, prevKc1Data.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="kc1-row" style="display: none;">
                                <td style="padding-left: 30px;">RPC</td>
                                <td class="text-right">${rpcKc1Data.calls.toLocaleString()} ${createChangeBadge(rpcKc1Data.calls, prevRpcKc1Data.calls)}</td>
                                <td class="text-right">${rpcKc1Data.deviations.toLocaleString()} ${createChangeBadge(rpcKc1Data.deviations, prevRpcKc1Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(rpcKc1Data.percentage)}">${rpcKc1Data.percentage}%</span> ${createChangeBadge(rpcKc1Data.percentage, prevRpcKc1Data.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="kc1-row-2" style="display: none;">
                                <td style="padding-left: 30px;">Не RPC</td>
                                <td class="text-right">${nonRpcKc1Data.calls.toLocaleString()} ${createChangeBadge(nonRpcKc1Data.calls, prevNonRpcKc1Data.calls)}</td>
                                <td class="text-right">${nonRpcKc1Data.deviations.toLocaleString()} ${createChangeBadge(nonRpcKc1Data.deviations, prevNonRpcKc1Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(nonRpcKc1Data.percentage)}">${nonRpcKc1Data.percentage}%</span> ${createChangeBadge(nonRpcKc1Data.percentage, prevNonRpcKc1Data.percentage)}</td>
                            </tr>
                            <tr class="expandable-row" onclick="toggleExpansion('kc2-row')">
                                <td>КЦ 2 <span class="expand-icon" id="kc2-icon">▼</span></td>
                                <td class="text-right">${kc2Data.calls.toLocaleString()} ${createChangeBadge(kc2Data.calls, prevKc2Data.calls)}</td>
                                <td class="text-right">${kc2Data.deviations.toLocaleString()} ${createChangeBadge(kc2Data.deviations, prevKc2Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(kc2Data.percentage)}">${kc2Data.percentage}%</span> ${createChangeBadge(kc2Data.percentage, prevKc2Data.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="kc2-row" style="display: none;">
                                <td style="padding-left: 30px;">RPC</td>
                                <td class="text-right">${rpcKc2Data.calls.toLocaleString()} ${createChangeBadge(rpcKc2Data.calls, prevRpcKc2Data.calls)}</td>
                                <td class="text-right">${rpcKc2Data.deviations.toLocaleString()} ${createChangeBadge(rpcKc2Data.deviations, prevRpcKc2Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(rpcKc2Data.percentage)}">${rpcKc2Data.percentage}%</span> ${createChangeBadge(rpcKc2Data.percentage, prevRpcKc2Data.percentage)}</td>
                            </tr>
                            <tr class="detail-row" id="kc2-row-2" style="display: none;">
                                <td style="padding-left: 30px;">Не RPC</td>
                                <td class="text-right">${nonRpcKc2Data.calls.toLocaleString()} ${createChangeBadge(nonRpcKc2Data.calls, prevNonRpcKc2Data.calls)}</td>
                                <td class="text-right">${nonRpcKc2Data.deviations.toLocaleString()} ${createChangeBadge(nonRpcKc2Data.deviations, prevNonRpcKc2Data.deviations)}</td>
                                <td class="text-right"><span class="${getPercentageClass(nonRpcKc2Data.percentage)}">${nonRpcKc2Data.percentage}%</span> ${createChangeBadge(nonRpcKc2Data.percentage, prevNonRpcKc2Data.percentage)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            } else {
                // Если выбран конкретный КЦ, показываем стандартную таблицу
                const currentData = companyData.current;
                const previousData = companyData.previous;

                const kcKey = selectedCallCenter === 'КЦ 1' ? 'kc1' : 'kc2';
                const totalData = currentData[kcKey];
                const rpcData = currentData.rpc[kcKey];
                const nonRpcData = currentData.nonRpc[kcKey];

                const prevTotalData = previousData[kcKey];
                const prevRpcData = previousData.rpc[kcKey];
                const prevNonRpcData = previousData.nonRpc[kcKey];

                tableHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ПАРАМЕТР</th>
                                <th class="text-right">ВСЕГО</th>
                                <th class="text-right">RPC</th>
                                <th class="text-right">НЕ RPC</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Оценено звонков</td>
                                <td class="text-right">${totalData.calls.toLocaleString()} ${createChangeBadge(totalData.calls, prevTotalData.calls)}</td>
                                <td class="text-right">${rpcData.calls.toLocaleString()} ${createChangeBadge(rpcData.calls, prevRpcData.calls)}</td>
                                <td class="text-right">${nonRpcData.calls.toLocaleString()} ${createChangeBadge(nonRpcData.calls, prevNonRpcData.calls)}</td>
                            </tr>
                            <tr>
                                <td>Отклонений выявлено</td>
                                <td class="text-right">${totalData.deviations.toLocaleString()} ${createChangeBadge(totalData.deviations, prevTotalData.deviations)}</td>
                                <td class="text-right">${rpcData.deviations.toLocaleString()} ${createChangeBadge(rpcData.deviations, prevRpcData.deviations)}</td>
                                <td class="text-right">${nonRpcData.deviations.toLocaleString()} ${createChangeBadge(nonRpcData.deviations, prevNonRpcData.deviations)}</td>
                            </tr>
                            <tr>
                                <td>% отклонений</td>
                                <td class="text-right"><span class="${getPercentageClass(totalData.percentage)}">${totalData.percentage}%</span> ${createChangeBadge(totalData.percentage, prevTotalData.percentage)}</td>
                                <td class="text-right"><span class="${getPercentageClass(rpcData.percentage)}">${rpcData.percentage}%</span> ${createChangeBadge(rpcData.percentage, prevRpcData.percentage)}</td>
                                <td class="text-right"><span class="${getPercentageClass(nonRpcData.percentage)}">${nonRpcData.percentage}%</span> ${createChangeBadge(nonRpcData.percentage, prevNonRpcData.percentage)}</td>
                            </tr>
                        </tbody>
                    </table>
                `;
            }

            tableContainer.innerHTML = tableHTML;
        }

        // Функция для обновления данных подразделений
        async function updateDepartmentsData() {
            const granularity = document.getElementById('timeGranularity').value;
            const callCenter = document.getElementById('callCenter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            showLoading('departmentsTable');
            updatePeriodInfo(granularity, 'departmentsPeriodInfo');

            try {
                const departmentsData = await getDepartmentsData(startDate, endDate, granularity, callCenter);

                if (!departmentsData) {
                    showError('departmentsTable', 'Не удалось загрузить данные подразделений');
                    return;
                }

                renderDepartmentsTable(departmentsData);
            } catch (error) {
                console.error('Ошибка при обновлении данных подразделений:', error);
                showError('departmentsTable', error.message);
            }
        }

        // Функция для отрисовки таблицы подразделений
        function renderDepartmentsTable(departmentsData) {
            const tableContainer = document.getElementById('departmentsTable');
            if (!tableContainer) return;

            let tableHTML = `
                <h4>Подразделения</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ПОДРАЗДЕЛЕНИЕ</th>
                            <th class="text-right">КОНТАКТ-ЦЕНТР</th>
                            <th class="text-right">ОЦЕНЕНО ЗВОНКОВ</th>
                            <th class="text-right">ОТКЛОНЕНИЙ</th>
                            <th class="text-right">% ОТКЛОНЕНИЙ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            departmentsData.current.forEach((dept, index) => {
                const prevDept = departmentsData.previous[index] || { calls: 0, deviations: 0, percentage: 0 };

                tableHTML += `
                    <tr>
                        <td>${dept.name}</td>
                        <td class="text-right">${dept.callCenter}</td>
                        <td class="text-right">${dept.calls.toLocaleString()} ${createChangeBadge(dept.calls, prevDept.calls)}</td>
                        <td class="text-right">${dept.deviations.toLocaleString()} ${createChangeBadge(dept.deviations, prevDept.deviations)}</td>
                        <td class="text-right"><span class="${getPercentageClass(dept.percentage)}">${dept.percentage}%</span> ${createChangeBadge(dept.percentage, prevDept.percentage)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        // Функция для обновления данных сотрудников
        async function updateEmployeesData() {
            const granularity = document.getElementById('timeGranularity').value;
            const callCenter = document.getElementById('callCenter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            showLoading('employeesTable');
            updatePeriodInfo(granularity, 'employeesPeriodInfo');

            try {
                const employeesData = await getEmployeesData(startDate, endDate, granularity, callCenter);

                if (!employeesData) {
                    showError('employeesTable', 'Не удалось загрузить данные сотрудников');
                    return;
                }

                renderEmployeesTable(employeesData);
            } catch (error) {
                console.error('Ошибка при обновлении данных сотрудников:', error);
                showError('employeesTable', error.message);
            }
        }

        // Функция для отрисовки таблицы сотрудников
        function renderEmployeesTable(employeesData) {
            const tableContainer = document.getElementById('employeesTable');
            if (!tableContainer) return;

            let tableHTML = `
                <h4>Сотрудники</h4>
                <table>
                    <thead>
                        <tr>
                            <th>СОТРУДНИК</th>
                            <th>ПОДРАЗДЕЛЕНИЕ</th>
                            <th class="text-right">КЦ</th>
                            <th class="text-right">ОЦЕНЕНО ЗВОНКОВ</th>
                            <th class="text-right">ОТКЛОНЕНИЙ</th>
                            <th class="text-right">% ОТКЛОНЕНИЙ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            employeesData.current.forEach((emp, index) => {
                const prevEmp = employeesData.previous[index] || { calls: 0, deviations: 0, percentage: 0 };

                tableHTML += `
                    <tr>
                        <td>${emp.name}</td>
                        <td>${emp.department}</td>
                        <td class="text-right">${emp.callCenter}</td>
                        <td class="text-right">${emp.calls.toLocaleString()} ${createChangeBadge(emp.calls, prevEmp.calls)}</td>
                        <td class="text-right">${emp.deviations.toLocaleString()} ${createChangeBadge(emp.deviations, prevEmp.deviations)}</td>
                        <td class="text-right"><span class="${getPercentageClass(emp.percentage)}">${emp.percentage}%</span> ${createChangeBadge(emp.percentage, prevEmp.percentage)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            tableContainer.innerHTML = tableHTML;
        }

        // Функция для обновления активной вкладки
        async function updateActiveTab() {
            console.log('=== updateActiveTab вызвана ===');
            console.log('currentTab:', currentTab);

            switch (currentTab) {
                case 'company':
                    console.log('Обновляем данные компании...');
                    await updateCompanyData();
                    break;
                case 'departments':
                    console.log('Обновляем данные подразделений...');
                    await updateDepartmentsData();
                    break;
                case 'employees':
                    await updateEmployeesData();
                    break;
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function () {
            // Инициализация вкладок
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function () {
                    const tabId = this.getAttribute('data-tab');

                    // Убираем активный класс у всех кнопок и содержимого вкладок
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Добавляем активный класс выбранной кнопке и содержимому
                    this.classList.add('active');
                    document.getElementById(tabId + 'Tab').classList.add('active');

                    // Обновляем текущую вкладку
                    currentTab = tabId;

                    // Загружаем данные для новой активной вкладки
                    setTimeout(updateActiveTab, 100);
                });
            });

            // Обработчик кнопки "Обновить"
            document.getElementById('updateButton').addEventListener('click', async function () {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const granularity = document.getElementById('timeGranularity').value;

                // Проверяем валидность диапазона дат
                if (!validateDateRange(startDate, endDate, granularity)) {
                    return;
                }

                await updateActiveTab();
            });

            // Обработчики изменения фильтров
            document.getElementById('timeGranularity').addEventListener('change', updateActiveTab);
            document.getElementById('callCenter').addEventListener('change', updateActiveTab);

            // Загружаем данные для начальной вкладки
            setTimeout(updateActiveTab, 500);
        });
    </script>
</body>

</html>